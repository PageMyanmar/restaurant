{% load static %}
<link rel="stylesheet" href="{% static 'css/sweetalert2.min.css' %}">
<!-- SweetAlert2 JavaScript -->
<script src="{% static 'js/sweetalert2.all.min.js' %}"></script>

{% if request.user.is_authenticated %}
<!-- Django Messages to SweetAlert2 -->
<script>
    {% if messages %}
    {% for message in messages %}
    // Determine the icon, background, and color based on the message level tag
    let icon, background, textColor;
    let messageTag = '{{ message.tags|escapejs }}'.toLowerCase(); // Get the actual tag name from settings.py

    if (messageTag === 'alert-success') {
        icon = 'success';
        background = '#155724';
        textColor = '#d4edda';
    } else if (messageTag === 'alert-danger') {
        icon = 'error';
        background = '#721c24';
        textColor = '#f8d7da';
    } else if (messageTag === 'alert-warning') {
        icon = 'warning';
        background = '#856404';
        textColor = '#fff3cd';
    } else if (messageTag === 'alert-info') {
        icon = 'info';
        background = '#0c5460';
        textColor = '#d1ecf1';
    } else {
        icon = 'info';
        background = '#0c5460';
        textColor = '#d1ecf1';
    }

    Swal.fire({
        toast: true,
        position: 'top-end',
        icon: icon,
        title: '{{ message|escapejs }}',
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true,
        background: background,
        color: textColor
    });
    {% endfor %}
    {% endif %}
</script>

<!-- WebSocket Real-Time Messages -->
<script>
    // Initialize WebSocket connection
    const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const socket = new WebSocket(`${protocol}://${window.location.host}/ws/messages/`);

    // Log connection events
    socket.onopen = function () {
        console.log('WebSocket connection opened');
    };

    socket.onerror = function (error) {
        console.error('WebSocket encountered an error:', error);
    };

    socket.onclose = function (event) {
        console.log('WebSocket closed:', event.code, event.reason);
    };

    let positionY = 0; // Track vertical position to stack notifications

    // Handle incoming messages
    socket.onmessage = function (event) {
        const data = JSON.parse(event.data);
        const message = data.message;
        const alertType = data.type || "alert-info"; // Default to info if no type is provided

        // Determine the icon, background, and color based on the message type
        let icon, background, textColor;

        if (alertType === 'alert-success') {
            icon = 'success';
            background = '#155724';
            textColor = '#d4edda';
        } else if (alertType === 'alert-danger') {
            icon = 'error';
            background = '#721c24';
            textColor = '#f8d7da';
        } else if (alertType === 'alert-warning') {
            icon = 'warning';
            background = '#856404';
            textColor = '#fff3cd';
        } else if (alertType === 'alert-info') {
            icon = 'info';
            background = '#0c5460';
            textColor = '#d1ecf1';
        } else {
            icon = 'info';
            background = '#0c5460';
            textColor = '#d1ecf1';
        }

        // Display each incoming message in sequence
        Swal.fire({
            toast: true,
            position: 'top-start', // Stack notifications at the top-left
            icon: icon,
            title: message, // The message text
            showConfirmButton: true,
            background: background,
            color: textColor,
            // timer: 3000, // Optional: set timer for auto-close
            willClose: () => {
                // Move the next notification below the previous one
                positionY += 40;  // Adjust the number based on your need for spacing
            },
            didOpen: () => {
                // Adjust the margin-top dynamically to stack notifications
                document.querySelector('.swal2-toast').style.marginTop = `${positionY}px`;
            }
        });
    };
</script>

<style>
    /* Styling for message box */
    #message-container {
        position: fixed;
        top: 100px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column-reverse;
        /* Ensures the newest messages appear on top */
        gap: 10px;
    }

    .message-box {
        min-width: 400px;
    }

    .message-box .btn-close i {
        padding-bottom: 15px;
    }

    @media (max-width: 600px) {
        .message-box {
            min-width: 200px;
        }
    }
</style>
{% endif %}