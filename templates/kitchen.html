{% extends 'components/base.html' %}

{% block title %}Kitchen{% endblock %}
{% load static %}
{% block body %}

<!--=============== CHECKOUT ===============-->
<section class="checkout section--lg container">
    <div class="checkout__container grid" id="orders">

    <div class="checkout__group">
        <h3 class="section__title">Table Name Here</h3>
        <table class="order__table" id="order">
            <!-- Table Header -->
            <tr>
                <th colspan="2">Items</th>
                <th>Quantity</th>
            </tr>
        </table>
    </div>

    <div class="divider">
        <i class="fi fi-rs-fingerprint"></i>
    </div>

</section>


<script>
    // Establish WebSocket connection
    const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const socket = new WebSocket(`${protocol}://${window.location.host}/ws/notifications/`);

    // Handle incoming WebSocket messages
    socket.onmessage = function (event) {
        // Parse the incoming message
        const data = JSON.parse(event.data);
        const datas = data.message;
        const items = datas.items; // Extract items array from the message

        // Get reference to the table
        const ordersContainer = document.getElementById('order');

        // Clear existing rows except the header row
        const rows = ordersContainer.querySelectorAll('tr');
        rows.forEach((row, index) => {
            if (index !== 0) row.remove(); // Remove all rows except the first (header)
        });

        // Populate the table with new data
        items.forEach(item => {
            const row = document.createElement('tr'); // Create a new row

            // Add image column
            const imgCell = document.createElement('td');
            const img = document.createElement('img');
            img.src = "{% static 'img/sample-pd.png' %}"; // Placeholder image
            img.alt = item.product_name;
            img.className = 'order__img';
            imgCell.appendChild(img);
            row.appendChild(imgCell);

            // Add product name column
            const nameCell = document.createElement('td');
            const nameTitle = document.createElement('h3');
            nameTitle.className = 'table__title';
            nameTitle.textContent = item.product_name;
            nameCell.appendChild(nameTitle);
            row.appendChild(nameCell);

            // Add quantity column
            const quantityCell = document.createElement('td');
            const quantitySpan = document.createElement('span');
            quantitySpan.className = 'table__price';
            quantitySpan.textContent = item.quantity;
            quantityCell.appendChild(quantitySpan);
            row.appendChild(quantityCell);

            // Append the new row to the table
            ordersContainer.appendChild(row);
        });
    };

    // Handle WebSocket errors
    socket.onerror = function (error) {
        console.error('WebSocket error:', error);
    };
</script>

{% endblock %}